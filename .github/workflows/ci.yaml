name: CI

on:
  push:
    branches:
      - main
  pull_request: ~
  workflow_dispatch: ~

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  tests:
    name: ğŸ§ª Run Tests & Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      # ğŸ”¹ Preparazione
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false
      - name: ğŸ§° Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ğŸ”¹ Build
      - name: ğŸ—ï¸ Build Docker images
        uses: docker/bake-action@v6
        with:
          pull: true
          load: true
          files: |
            compose.yaml
            compose.override.yaml
          set: |
            *.cache-from=type=gha,scope=${{github.ref}}
            *.cache-from=type=gha,scope=refs/heads/main
            *.cache-to=type=gha,scope=${{github.ref}},mode=max

      # ğŸ”¹ Start services
      - name: ğŸš€ Start services
        run: docker compose up --wait --no-build
      - name: ğŸŒ Check HTTP reachability
        run: curl -v --fail-with-body http://localhost

      # ğŸ”¹ Test
      - name: ğŸ“ Run PHPUnit tests with coverage
        run: docker compose exec -it php composer test-with-coverage

      # ğŸ”¹ Code quality
      - name: ğŸ¨ Run PHPCSFixer dry-run
        run: docker compose exec -it php composer php-cs-fixer-dry-run

      # ğŸ”¹ Coverage upload
      - name: â˜ï¸ Upload coverage reports to Codecov
        uses: qltysh/qlty-action/coverage@v2
        with:
          token: ${{secrets.QLTY_COVERAGE_TOKEN}}
          files: clover.xml
          strip-prefix: /app
          command: publish
