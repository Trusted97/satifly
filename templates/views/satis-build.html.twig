{% extends "base.html.twig" %}

{% block title %}Satis Build{% endblock %}

{% block content %}

    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('admin') }}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Satis Build</li>
        </ol>
    </nav>

    <div class="card shadow-sm my-4">
        <div class="card-header bg-light d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                 class="bi bi-hammer text-primary me-2" viewBox="0 0 16 16">
                <path
                    d="M9.972 2.508a.5.5 0 0 0-.16-.556l-.178-.129a5 5 0 0 0-2.076-.783C6.215.862 4.504 1.229 2.84 3.133H1.786a.5.5 0 0 0-.354.147L.146 4.567a.5.5 0 0 0 0 .706l2.571 2.579a.5.5 0 0 0 .708 0l1.286-1.29a.5.5 0 0 0 .146-.353V5.57l8.387 8.873A.5.5 0 0 0 14 14.5l1.5-1.5a.5.5 0 0 0 .017-.689l-9.129-8.63c.747-.456 1.772-.839 3.112-.839a.5.5 0 0 0 .472-.334"/>
            </svg>
            <h5 class="mb-0">Satis Build Process</h5>
        </div>

        <div class="card-body">
            <p class="lead mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                     fill="currentColor" class="bi bi-hourglass-split text-warning me-2"
                     viewBox="0 0 16 16">
                    <path
                        d="M2.5 15a.5.5 0 1 1 0-1h1v-1a4.5 4.5 0 0 1 2.557-4.06c.29-.139.443-.377.443-.59v-.7c0-.213-.154-.451-.443-.59A4.5 4.5 0 0 1 3.5 3V2h-1a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-1v1a4.5 4.5 0 0 1-2.557 4.06c-.29.139-.443.377-.443.59v.7c0 .213.154.451.443.59A4.5 4.5 0 0 1 12.5 13v1h1a.5.5 0 0 1 0 1zm2-13v1c0 .537.12 1.045.337 1.5h6.326c.216-.455.337-.963.337-1.5V2zm3 6.35c0 .701-.478 1.236-1.011 1.492A3.5 3.5 0 0 0 4.5 13s.866-1.299 3-1.48zm1 0v3.17c2.134.181 3 1.48 3 1.48a3.5 3.5 0 0 0-1.989-3.158C8.978 9.586 8.5 9.052 8.5 8.351z"/>
                </svg>
                Build in progress — please wait while Satis generates your repository.
            </p>

            <div class="position-relative">
                <div id="satisOutput"
                     class="border rounded p-3 bg-dark text-light font-monospace"
                     style="height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;">
                </div>

                <div id="loadingSpinner"
                     class="text-center position-absolute top-50 start-50 translate-middle">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-light mt-2">Building...</p>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
    const output = document.getElementById("satisOutput");
    const spinner = document.getElementById("loadingSpinner");
    const source = new EventSource("{{ path('satis_build_run') }}");

    const appendLine = (text, className = "") => {
        const line = document.createElement("div");
        line.textContent = text;
        if (className) line.classList.add(className);
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;
    };

    source.onmessage = (event) => {
        spinner.style.display = "none";

        if (event.data === "__done__") {
            source.close();

            const successAlert = document.createElement("div");
            successAlert.className = "alert alert-success mt-3 fw-bold";
            successAlert.innerHTML = "✅ Build completed successfully!";
            output.appendChild(successAlert);
            output.scrollTop = output.scrollHeight;
            return;
        }

        appendLine(event.data);
    };

    source.onerror = () => {
        source.close();

        const errorAlert = document.createElement("div");
        errorAlert.className = "alert alert-danger mt-3 fw-bold";
        errorAlert.innerHTML = "⚠️ Connection interrupted. Please refresh the page to retry.";
        output.appendChild(errorAlert);
        output.scrollTop = output.scrollHeight;

        spinner.style.display = "none";
    };
});
</script>
{% endblock %}
